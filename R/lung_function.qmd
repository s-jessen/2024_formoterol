---
title: ""
format: html
editor: source
self-contained: true
---

```{r, include = F}
#Load libraries
knitr::opts_chunk$set(message = FALSE, warning = FALSE, error=FALSE)
source(here::here("R/libraries.R"))
source(here::here("R/functions.R"))
source(here::here("R/colors.R"))
```


```{r, echo = F}
#Load data
df <- readxl::read_excel(here::here('data-raw/lung_function.xlsx')) %>% 
    dplyr::select(-c("fvc_pre", "fvc_post", "fvc_perc_post", "fev_perc_post", "ex", "in")) %>%
    tidyr::pivot_longer(
        cols = -c(id, sex, treatment, visit), 
        names_to = "time", 
        values_to = "fev1"
        ) %>% 
    dplyr::mutate(time = factor(time, levels = c("fev_pre",
                                                 1,
                                                 2,
                                                 4,
                                                 5,
                                                 6,
                                                 7,
                                                 8,
                                                 9,
                                                 "sal_1",
                                                 "sal_5",
                                                 "sal_10",
                                                 "sal_15",
                                                 "fev_post",
                                                 "fev_1",
                                                 "fev_5",
                                                 "fev_10",
                                                 "fev_15",
                                                 "fev_20"
                                                 ))) %>% 
    dplyr::mutate(id = factor(id)) %>% 
    dplyr::group_by(id) %>% 
    dplyr::mutate(fev1 = ((fev1 - fev1[time == "fev_pre"])/fev1)*100) %>% 
    dplyr::ungroup()

```


```{r}
ggplot(df)+
    stat_summary(aes(
        x = time,
        y = fev1,
        group = id
        ),
        color = "gray",
        fun = "mean",
        geom = "line",
        linewidth = 1,
        na.rm = TRUE,
        show.legend = T,
        alpha = 1)+
    stat_summary(aes(
        x = time,
        y = fev1,
        group = 1
        ),
        color = "red",
        fun = "mean",
        geom = "line",
        linewidth = 1,
        na.rm = TRUE,
        show.legend = T,
        alpha = 1)+
    theme(
        panel.background = element_blank(),
        plot.background = element_blank(),
        panel.border = element_rect(linewidth = 0.15, fill = NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(size  = 8, color = "black", angle = 90, vjust = 0, hjust = 1),
        axis.text.y = element_text(size = 8, color = "black"),
        axis.ticks = element_line(color = "black", linewidth = 0.1),
        #legend.position = "none",
        plot.title = element_text(size = 8),
        text = element_text(family = "Source Sans Pro", size=8),
        strip.background = element_blank()
    )+
    labs(y = "FEV1 (% of pre)", x = "Time")
```


