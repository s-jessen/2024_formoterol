---
title: ""
format: html
editor: source
self-contained: true
---

```{r, include = F}
#Load libraries
knitr::opts_chunk$set(message = FALSE, warning = FALSE, error=FALSE)
source(here::here("R/libraries.R"))
source(here::here("R/functions.R"))
source(here::here("R/colors.R"))
```


```{r, echo = F}
#Load data
df <- readxl::read_excel(here::here('data-raw/for_data.xlsx')) %>% 
    dplyr::filter(treatment != "man") %>% #Remove manitol
    dplyr::mutate(id = as.factor(id)) %>% 
    dplyr::mutate(sex = factor(sex, levels = c("M", "W"))) %>%
    dplyr::mutate(treatment = factor(treatment, levels = c("pla", "for_i", "for_o", "sym", "man"))) %>%
    dplyr::group_by(id) %>% 
    dplyr::mutate(delta_tt_mpo = tt_mpo - tt_mpo[treatment == "pla"]) %>% 
    dplyr::mutate(delta_sprint_mpo = sprint_mpo - sprint_mpo[treatment == "pla"]) %>% 
    dplyr::mutate(delta_sprint_ppo = sprint_ppo - sprint_ppo[treatment == "pla"]) %>% 
    dplyr::mutate(delta_mvc = mvc - mvc[treatment == "pla"]) %>% 
    dplyr::mutate(delta_tpot = tpot - tpot[treatment == "pla"]) %>% 
    dplyr::mutate(delta_tpt = tpt - tpt[treatment == "pla"]) %>% 
    dplyr::mutate(delta_hrt = hrt - hrt[treatment == "pla"]) %>%
    dplyr::mutate(delta_va = va - va[treatment == "pla"]) %>% 
    dplyr::mutate(visit = factor(visit))
```

# TT MPO
```{r, echo = F}
barplot(df, "delta_tt_mpo", "Change in MPO relative to placebo (W)")

ggsave(here::here("data/figures/tt_mpo.png"), dpi = 600)
```

```{r, echo = F}
#Fit model
lm <- lmer(tt_mpo ~ treatment + (1|id), data = df, REML=FALSE)

#Show overall ANOVA output
anova(lm)

#Show estimated marginal means
emmeans(lm, specs = pairwise ~ treatment, adjust="none", pbkrtest.limit = 5000, lmerTest.limit = 5000) %>% 
    summary(infer=TRUE)

```

# Sprint PPO
```{r, echo = F}
barplot(df, "delta_sprint_ppo", "Change in sprint PPO relative to placebo (W)")

ggsave(here::here("data/figures/ppo.png"), dpi = 600)
```

```{r, , echo = F}
#Fit model
lm <- lmer(sprint_ppo ~ treatment + (1|id), data = df, REML=FALSE)

#Show overall ANOVA output
anova(lm)

#Show estimated marginal means
emmeans(lm, specs = pairwise ~ treatment, adjust="none", pbkrtest.limit = 5000, lmerTest.limit = 5000) %>% 
    summary(infer=TRUE)

```

# Sprint MPO
```{r, echo = F}
barplot(df, "delta_sprint_mpo", "Change in sprint MPO relative to placebo (W)")

ggsave(here::here("data/figures/mpo.png"), dpi = 600)
```

```{r, , echo = F}
#Fit model
lm <- lmer(sprint_mpo ~ treatment + (1|id), data = df, REML=FALSE)

#Show overall ANOVA output
anova(lm)

#Show estimated marginal means
emmeans(lm, specs = pairwise ~ treatment, adjust="none", pbkrtest.limit = 5000, lmerTest.limit = 5000) %>% 
    summary(infer=TRUE)

```

# MVC
```{r}
barplot(df, "delta_mvc", "Change in MVC (Nm)")

ggsave(here::here("data/figures/mvc.png"), dpi = 600)
```

```{r, , echo = F}
#Fit model
lm <- lmer(mvc ~ treatment + (1|id), data = df, REML=FALSE)

#Show overall ANOVA output
anova(lm)

#Show estimated marginal means
emmeans(lm, specs = pairwise ~ treatment, adjust="none", pbkrtest.limit = 5000, lmerTest.limit = 5000) %>% 
    summary(infer=TRUE)

```

# VA
```{r}
barplot(df, "delta_va", "Change in VA (%.)")

ggsave(here::here("data/figures/va.png"), dpi = 600)
```

```{r, , echo = F}
#Fit model
lm <- lmer(va ~ treatment + (1|id), data = df, REML=FALSE)

#Show overall ANOVA output
anova(lm)

#Show estimated marginal means
emmeans(lm, specs = pairwise ~ treatment, adjust="none", pbkrtest.limit = 5000, lmerTest.limit = 5000) %>% 
    summary(infer=TRUE)

```

# TPT
```{r}
barplot(df, "delta_tpt", "Change in TPT (ms)")

ggsave(here::here("data/figures/tpt.png"), dpi = 600)
```

```{r, , echo = F}
#Fit model
lm <- lmer(tpt ~ treatment + (1|id), data = df, REML=FALSE)

#Show overall ANOVA output
anova(lm)

#Show estimated marginal means
emmeans(lm, specs = pairwise ~ treatment, adjust="none", pbkrtest.limit = 5000, lmerTest.limit = 5000) %>% 
    summary(infer=TRUE)

```

# Correlations
```{r, echo = F}
df %>% 
    dplyr::filter(treatment != "pla") %>% 
    ggplot(aes(x = weight, y = delta_tt_mpo))+
        geom_point(size = 4, aes(color = sex))+
    geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.25)+
    geom_smooth(method = "lm",
                se = T,
                linetype = "solid",
                linewidth = 0.75,
                aes(color = "black"))+
    ggpubr::stat_cor(aes(label = paste(..rr.label.., ..p.label.., sep = "~~~")),
                     label.x = 55,
                     label.y = 28,
                     size = 3,
                     color = "black") +
    theme(
        panel.background = element_blank(),
        panel.border = element_rect(colour = "black", fill=NA, linewidth = 0.25),
        panel.grid.minor=element_blank(),
        panel.grid.major = element_blank(),
        plot.background = element_rect(fill = "white"),
        axis.line = element_blank(),
        axis.text = element_text(color = "black"),
        #axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        text = element_text(size = 8, family="Source Sans Pro", color = "black"),
        axis.title = element_text(size = 8, family="Source Sans Pro"),
        legend.title = element_blank(),
        legend.key = element_blank(),
        legend.key.size = (unit(3, "mm")),
        #legend.position = c(0.05, 0.99), 
        #legend.justification = c(0, 1), 
        #legend.box.just = "left", 
        #legend.margin = margin(0, 0, 0, 0),
        legend.background = element_blank(),
        legend.box.background = element_blank(),
        title = element_text(size = 6),
        aspect.ratio = 1,
        strip.background = element_blank()
        )+
    scale_color_manual(
            values = c(M = male_color, W = female_color),
            labels = c(M = "Male", W = "Female"))+
    labs(x = "Body weight (kg)", y = "Change in TT MPO (W)")+
    facet_grid(~treatment, labeller = as_labeller(c(for_i = "FOR inhaled (54 µg)",
                       for_o = "FOR oral (120 µg)",
                       sym = "Symbicort\n (54 µg inh. formoterol\n+1920 µg budesonide)",
                       man = "Mannitol")))

ggsave(here::here("data/figures/correlations.png"), dpi = 600)

```
No apparent effect of relative dose.

# Alternative statistics
```{r}
#Alternative
lm <- lme(tt_mpo ~ treatment, 
             random = ~ 1 | id, 
             correlation = corSymm(form = ~ 1 | id/treatment),
             data = df,
             method = "REML")

#Show overall ANOVA output
anova(lm)

#Show estimated marginal means
emmeans(lm, specs = pairwise ~ treatment, adjust="none", pbkrtest.limit = 5000, lmerTest.limit = 5000) %>% 
    summary(infer=TRUE)

```
